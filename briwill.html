<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Briwill - Your Premier Online Shopping Destination</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9; /* Light grey background */
        }
        /* Custom styles for aesthetic elements */
        .shadow-custom {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.04);
        }
        .text-briwill-primary { color: #f59e0b; } /* Orange accent */
        .bg-briwill-primary { background-color: #f59e0b; }
        .border-briwill-primary { border-color: #f59e0b; }
        /* Style for modals */
        .modal-active {
            display: flex;
        }
    </style>
    <!-- Lucide icons for clean UI elements -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="min-h-screen antialiased">

    <!-- 1. FULL-SCREEN AUTHENTICATION PAGE -->
    <div id="auth-page" class="fixed inset-0 bg-gray-100 z-[100] flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden p-6 sm:p-8">
            
            <!-- NEW: Header with Title and Close Button (The "Back" button) -->
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-4xl font-extrabold text-briwill-primary tracking-tight">Briwill</h1>
                <button onclick="window.hideAuthPage()" title="Close and return to shopping" class="p-1 text-gray-400 hover:text-gray-700 transition duration-150 rounded-full hover:bg-gray-100">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- Auth Message Box -->
            <div id="auth-message-box" class="hidden p-3 mb-4 rounded-lg text-sm font-medium"></div>

            <!-- Tab Navigation -->
            <div class="flex mb-6 border-b border-gray-200">
                <button id="signin-tab" onclick="window.showAuthView('signin')" class="w-1/2 pb-3 text-center font-bold text-gray-900 border-b-4 border-briwill-primary transition duration-200">Sign In</button>
                <button id="signup-tab" onclick="window.showAuthView('signup')" class="w-1/2 pb-3 text-center font-bold text-gray-400 border-b-4 border-gray-200 transition duration-200 hover:text-gray-700">Create Account</button>
            </div>

            <!-- Sign In View -->
            <div id="signin-view" class="space-y-4">
                <!-- Social Logins -->
                <div class="space-y-3">
                    <button onclick="window.handleGoogleSignIn()" class="w-full bg-white border border-gray-300 text-gray-700 font-semibold py-2.5 rounded-lg hover:bg-gray-50 transition duration-150 flex items-center justify-center shadow-sm">
                        <img src="https://www.google.com/favicon.ico" class="w-5 h-5 mr-3" alt="Google logo">
                        Continue with Google
                    </button>
                    <button onclick="window.handleFacebookSignIn()" class="w-full bg-blue-600 text-white font-semibold py-2.5 rounded-lg hover:bg-blue-700 transition duration-150 flex items-center justify-center shadow-md">
                        <i data-lucide="facebook" class="w-5 h-5 mr-3 fill-white"></i>
                        Continue with Facebook
                    </button>
                </div>
                
                <div class="flex items-center my-4">
                    <div class="flex-grow border-t border-gray-300"></div>
                    <span class="flex-shrink mx-4 text-gray-500 text-sm">or</span>
                    <div class="flex-grow border-t border-gray-300"></div>
                </div>

                <!-- Email Login -->
                <input id="signin-email" type="email" placeholder="Email Address" required
                       class="w-full border-2 border-gray-300 rounded-lg p-3 focus:ring-blue-500 focus:border-blue-500">
                <input id="signin-password" type="password" placeholder="Password" required
                       class="w-full border-2 border-gray-300 rounded-lg p-3 focus:ring-blue-500 focus:border-blue-500">
                <button onclick="window.handleSignIn()" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center justify-center shadow-lg">
                    <span id="signin-btn-text">Sign In with Email</span>
                </button>
            </div>

            <!-- Sign Up View -->
            <div id="signup-view" class="space-y-4 hidden">
                <input id="signup-email" type="email" placeholder="Email Address" required
                       class="w-full border-2 border-gray-300 rounded-lg p-3 focus:ring-briwill-primary focus:border-briwill-primary">
                <input id="signup-password" type="password" placeholder="Create Password (min 6 chars)" required
                       class="w-full border-2 border-gray-300 rounded-lg p-3 focus:ring-briwill-primary focus:border-briwill-primary">
                <button onclick="window.handleSignUp()" class="w-full bg-briwill-primary text-white font-bold py-3 px-4 rounded-lg hover:bg-amber-600 transition duration-200 flex items-center justify-center shadow-lg">
                    <span id="signup-btn-text">Create Account</span>
                </button>

                <div class="flex items-center my-4">
                    <div class="flex-grow border-t border-gray-300"></div>
                    <span class="flex-shrink mx-4 text-gray-500 text-sm">or sign up with</span>
                    <div class="flex-grow border-t border-gray-300"></div>
                </div>
                
                <!-- Social Sign Up -->
                 <div class="space-y-3">
                    <button onclick="window.handleGoogleSignIn()" class="w-full bg-white border border-gray-300 text-gray-700 font-semibold py-2.5 rounded-lg hover:bg-gray-50 transition duration-150 flex items-center justify-center shadow-sm">
                        <img src="https://www.google.com/favicon.ico" class="w-5 h-5 mr-3" alt="Google logo">
                        Google
                    </button>
                    <button onclick="window.handleFacebookSignIn()" class="w-full bg-blue-600 text-white font-semibold py-2.5 rounded-lg hover:bg-blue-700 transition duration-150 flex items-center justify-center shadow-md">
                        <i data-lucide="facebook" class="w-5 h-5 mr-3 fill-white"></i>
                        Facebook
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. MAIN E-COMMERCE CONTENT -->
    <div id="main-app-content" class="min-h-screen transition-opacity duration-300">
        
        <!-- Header & Navigation -->
        <header class="bg-white shadow-custom sticky top-0 z-40" >
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-3">
                <div class="flex items-center justify-between">
                    <!-- Logo -->
                    <a href="#" class="text-3xl font-extrabold text-briwill-primary tracking-tight">
                        Briwill
                    </a>

                    <!-- Search Bar -->
                    <div class="hidden md:flex flex-grow max-w-lg mx-8">
                        <input type="search" placeholder="Search products, brands and categories..."
                            class="w-full px-4 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-briwill-primary">
                        <button class="bg-blue-600 text-white px-6 py-2 rounded-r-lg hover:bg-blue-700 transition duration-150 flex items-center">
                            <i data-lucide="search" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <!-- Icons (Account & Cart) -->
                    <nav class="flex items-center space-x-4">
                        <button id="account-button" onclick="window.showAuthPage('signin')" class="flex flex-col items-center text-gray-700 hover:text-briwill-primary transition duration-150">
                            <i data-lucide="user" class="w-6 h-6"></i>
                            <span class="text-xs hidden sm:block">Account</span>
                        </button>
                        <button id="cart-button" onclick="window.showCartModal()" class="flex flex-col items-center text-gray-700 hover:text-briwill-primary transition duration-150 relative">
                            <i data-lucide="shopping-cart" class="w-6 h-6"></i>
                            <span class="text-xs hidden sm:block">Cart</span>
                            <!-- Cart Count Badge (Updates from Firestore) -->
                            <span id="cart-count" class="absolute -top-1 -right-2 bg-red-600 text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full">0</span>
                        </button>
                        <!-- Mobile Menu Toggle -->
                        <button id="menu-toggle" class="md:hidden text-gray-700 hover:text-briwill-primary transition duration-150">
                            <i data-lucide="menu" class="w-6 h-6"></i>
                        </button>
                    </nav>
                </div>
                <!-- Mobile Search Bar -->
                <div class="mt-3 md:hidden flex">
                    <input type="search" placeholder="Search products, brands and categories..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-briwill-primary">
                    <button class="bg-blue-600 text-white px-4 py-2 rounded-r-lg hover:bg-blue-700 transition duration-150 flex items-center">
                        <i data-lucide="search" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            <!-- Mobile Menu Flyout - NOW FUNCTIONAL FOR CATEGORIES -->
            <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-gray-200 p-4">
                 <a href="#" id="mobile-filter-All" onclick="window.filterProducts('All')" class="block py-2 text-gray-700 font-bold bg-gray-100 rounded-lg pl-3 mb-2">All Products</a>
                <a href="#" id="mobile-filter-Tech" onclick="window.filterProducts('Tech')" class="flex items-center py-2 text-gray-700 hover:text-briwill-primary pl-3">
                    <i data-lucide="monitor" class="w-4 h-4 mr-2"></i> Tech
                </a>
                <a href="#" id="mobile-filter-Apparel" onclick="window.filterProducts('Apparel')" class="flex items-center py-2 text-gray-700 hover:text-briwill-primary pl-3">
                    <i data-lucide="shirt" class="w-4 h-4 mr-2"></i> Apparel
                </a>
                <a href="#" id="mobile-filter-Home" onclick="window.filterProducts('Home')" class="flex items-center py-2 text-gray-700 hover:text-briwill-primary pl-3">
                    <i data-lucide="sofa" class="w-4 h-4 mr-2"></i> Home & Kitchen
                </a>
                <a href="#" onclick="window.handleQuickLink('Health & Beauty')" class="flex items-center py-2 text-gray-700 hover:text-briwill-primary pl-3">
                    <i data-lucide="heart-handshake" class="w-4 h-4 mr-2"></i> Health & Beauty
                </a>
                <a href="#" onclick="window.handleQuickLink('Gaming')" class="flex items-center py-2 text-gray-700 hover:text-briwill-primary pl-3">
                    <i data-lucide="gamepad-2" class="w-4 h-4 mr-2"></i> Gaming
                </a>
            </div>
        </header>
        
        <!-- App Message Box (For quick link feedback, etc.) -->
        <div id="app-message-box" class="fixed top-0 left-1/2 -translate-x-1/2 mt-16 z-50 p-4 rounded-lg text-sm font-medium transition-opacity duration-300 opacity-0 pointer-events-none w-11/12 max-w-sm shadow-lg"></div>

        <!-- Main Content Area -->
        <main class="container mx-auto px-4 sm:px-6 lg:px-8 mt-6 pb-12">
            
            <!-- User Status Display (Hidden when using full-screen auth) -->
            <div id="user-status-card" class="bg-white p-4 rounded-xl shadow-md mb-6 hidden">
                <p class="text-sm font-semibold text-gray-700">
                    Logged in as: <span id="user-email-display" class="font-bold text-blue-600"></span>
                </p>
                <p class="text-xs text-gray-500 mt-1">
                    Your User ID: <span id="user-id-display" class="break-all font-mono text-gray-600"></span>
                </p>
                <button onclick="window.handleSignOut()" class="mt-3 bg-red-500 text-white text-xs py-1 px-3 rounded hover:bg-red-600 transition">
                    Sign Out
                </button>
            </div>
            
            <!-- Hero Banner & Side Links -->
            <div class="flex flex-col lg:flex-row gap-6">
                
                <!-- Side Categories (Desktop only) - NOW FUNCTIONAL FOR FILTERING -->
                <aside class="hidden lg:block w-full lg:w-1/5 bg-white rounded-xl shadow-md p-4 space-y-2 h-fit">
                    <h3 class="text-lg font-bold text-gray-800 mb-2 border-b pb-2">Top Categories</h3>
                    
                    <a href="#" id="desktop-filter-All" onclick="window.filterProducts('All')" class="flex items-center text-sm font-bold text-briwill-primary bg-yellow-50 p-1 rounded-lg">
                        <i data-lucide="layout-grid" class="w-4 h-4 mr-2"></i> All Products
                    </a>
                    
                    <!-- Tech Category -->
                    <a href="#" id="desktop-filter-Tech" onclick="window.filterProducts('Tech')" class="category-link flex items-center text-sm text-gray-600 hover:text-briwill-primary transition duration-100 p-1 rounded-lg">
                        <i data-lucide="monitor" class="w-4 h-4 mr-2"></i> Tech
                    </a>
                    <!-- Apparel Category -->
                    <a href="#" id="desktop-filter-Apparel" onclick="window.filterProducts('Apparel')" class="category-link flex items-center text-sm text-gray-600 hover:text-briwill-primary transition duration-100 p-1 rounded-lg">
                        <i data-lucide="shirt" class="w-4 h-4 mr-2"></i> Apparel
                    </a>
                    <!-- Home Category -->
                    <a href="#" id="desktop-filter-Home" onclick="window.filterProducts('Home')" class="category-link flex items-center text-sm text-gray-600 hover:text-briwill-primary transition duration-100 p-1 rounded-lg">
                        <i data-lucide="sofa" class="w-4 h-4 mr-2"></i> Home & Kitchen
                    </a>

                    <!-- Other Non-Functional Links -->
                    <a href="#" onclick="window.handleQuickLink('Health & Beauty')" class="flex items-center text-sm text-gray-600 hover:text-briwill-primary transition duration-100 p-1 rounded-lg">
                        <i data-lucide="heart-handshake" class="w-4 h-4 mr-2"></i> Health & Beauty
                    </a>
                    <a href="#" onclick="window.handleQuickLink('Gaming')" class="flex items-center text-sm text-gray-600 hover:text-briwill-primary transition duration-100 p-1 rounded-lg">
                        <i data-lucide="gamepad-2" class="w-4 h-4 mr-2"></i> Gaming
                    </a>
                    
                </aside>
                
                <!-- Hero Banner (Full width on mobile, right side on desktop) -->
                <section class="w-full lg:w-4/5 bg-gradient-to-r from-blue-700 to-blue-500 p-6 sm:p-10 rounded-xl shadow-lg relative overflow-hidden">
                    <div class="absolute inset-0 opacity-10 bg-black"></div>
                    <div class="relative z-10 flex flex-col items-start justify-center h-full">
                        <h1 class="text-3xl sm:text-5xl font-extrabold text-white leading-tight mb-3">
                            Briwill Mega Sale!
                        </h1>
                        <p class="text-lg sm:text-xl text-blue-100 mb-6">
                            Get up to <span class="text-briwill-primary font-bold">70% off</span> on all electronics this week only.
                        </p>
                        <button class="bg-briwill-primary text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-amber-600 transition duration-300 transform hover:scale-105">
                            Shop Now
                        </button>
                    </div>
                </section>
            </div>

            <!-- Quick Access/Deals Bar - NOW FUNCTIONAL -->
            <section class="mt-8 grid grid-cols-2 md:grid-cols-4 gap-4">
                <div id="flash-deals" onclick="window.handleFlashDeals()" class="bg-white p-4 rounded-xl shadow-md text-center hover:shadow-lg transition duration-200 cursor-pointer">
                    <i data-lucide="zap" class="w-8 h-8 mx-auto text-yellow-500 mb-2"></i>
                    <p class="text-sm font-semibold">Flash Deals</p>
                </div>
                <div id="free-shipping" onclick="window.handleQuickLink('Free Shipping')" class="bg-white p-4 rounded-xl shadow-md text-center hover:shadow-lg transition duration-200 cursor-pointer">
                    <i data-lucide="truck" class="w-8 h-8 mx-auto text-green-500 mb-2"></i>
                    <p class="text-sm font-semibold">Free Shipping</p>
                </div>
                <div id="official-store" onclick="window.handleQuickLink('Official Store')" class="bg-white p-4 rounded-xl shadow-md text-center hover:shadow-lg transition duration-200 cursor-pointer">
                    <i data-lucide="award" class="w-8 h-8 mx-auto text-blue-500 mb-2"></i>
                    <p class="text-sm font-semibold">Official Store</p>
                </div>
                <div id="pay-on-delivery" onclick="window.handleQuickLink('Pay On Delivery')" class="bg-white p-4 rounded-xl shadow-md text-center hover:shadow-lg transition duration-200 cursor-pointer">
                    <i data-lucide="credit-card" class="w-8 h-8 mx-auto text-red-500 mb-2"></i>
                    <p class="text-sm font-semibold">Pay On Delivery</p>
                </div>
            </section>

            <!-- Featured Products Grid -->
            <section class="mt-12">
                <!-- Filter Title - Updates with current category -->
                <h2 id="product-grid-title" class="text-2xl font-bold text-gray-800 mb-6 border-b-2 border-briwill-primary inline-block pb-1">
                    All Featured Products
                </h2>
                
                <div id="product-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 sm:gap-6">
                    <!-- Product Card Template (JS will fill this with data) -->
                </div>
            </section>

        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white mt-12">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-10">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-8">
                    <!-- Column 1: Briwill Info -->
                    <div>
                        <h4 class="text-lg font-bold mb-4 text-briwill-primary">Briwill</h4>
                        <ul class="space-y-2 text-sm text-gray-400">
                            <li><a href="#" class="hover:text-white transition duration-150">About Us</a></li>
                            <li><a href="#" class="hover:text-white transition duration-150">Careers</a></li>
                            <li><a href="#" class="hover:text-white transition duration-150">Our Blog</a></li>
                            <li><a href="#" class="hover:text-white transition duration-150">Terms & Conditions</a></li>
                        </ul>
                    </div>
                    <!-- Column 2: Customer Service -->
                    <div>
                        <h4 class="text-lg font-bold mb-4">Customer Service</h4>
                        <ul class="space-y-2 text-sm text-gray-400">
                            <li><a href="#" class="hover:text-white transition duration-150">Help Center</a></li>
                            <li><a href="#" class="hover:text-white transition duration-150">Contact Us</a></li>
                            <li><a href="#" class="hover:text-white transition duration-150">Return Policy</a></li>
                            <li><a href="#" class="hover:text-white transition duration-150">Shipping</a></li>
                        </ul>
                    </div>
                    <!-- Column 3: Make Money with Briwill -->
                    <div>
                        <h4 class="text-lg font-bold mb-4">Make Money</h4>
                        <ul class="space-y-2 text-sm text-gray-400">
                            <!-- UPDATED: Added specific click handler for Seller Portal -->
                            <li><a href="#" onclick="window.showSellerPortal(event)" class="hover:text-white transition duration-150">Sell on Briwill</a></li>
                            <li><a href="#" class="hover:text-white transition duration-150">Join Affiliate Program</a></li>
                            <li><a href="#" class="hover:text-white transition duration-150">Briwill Express</a></li>
                        </ul>
                    </div>
                    <!-- Column 4: Social -->
                    <div>
                        <h4 class="text-lg font-bold mb-4">Connect With Us</h4>
                        <div class="flex space-x-3">
                            <i data-lucide="facebook" class="w-6 h-6 hover:text-blue-500 cursor-pointer transition duration-150"></i>
                            <i data-lucide="instagram" class="w-6 h-6 hover:text-pink-500 cursor-pointer transition duration-150"></i>
                            <i data-lucide="twitter" class="w-6 h-6 hover:text-sky-400 cursor-pointer transition duration-150"></i>
                        </div>
                    </div>
                </div>
                <div class="mt-8 pt-6 border-t border-gray-700 text-center text-sm text-gray-400">
                    &copy; <span id="current-year"></span> Briwill Online Shopping. All rights reserved.
                </div>
            </div>
            <a href="#"> back to top</a>
        </footer>

    </div>
    
    <!-- 3. LLM Product Analysis Modal (Independent Overlay) -->
    <div id="analysis-modal" onclick="if(event.target.id === 'analysis-modal') closeAnalysisModal()" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-5 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    âœ¨ AI Shopping Assistant 
                </h3>
                <button onclick="window.closeAnalysisModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <!-- Modal Content -->
            <div class="p-5 space-y-4">
                <h4 id="analysis-product-name" class="font-semibold text-lg text-blue-600">Analyzing: Product Name...</h4>

                <!-- User Query Area -->
                <textarea id="analysis-query" rows="3" placeholder="Ask about this product, like 'What are the main competitors?' or 'Is this good for gaming?'" 
                          class="w-full border-2 border-gray-300 rounded-lg p-3 focus:ring-briwill-primary focus:border-briwill-primary resize-none"></textarea>
                
                <div class="flex justify-end">
                    <button id="analysis-submit-btn" onclick="window.submitAnalysisQuery()" class="bg-briwill-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-amber-600 transition duration-200 flex items-center">
                        <span id="analysis-btn-text">Get Insight</span>
                        <i data-lucide="send" class="w-4 h-4 ml-2"></i>
                    </button>
                </div>

                <!-- AI Response Area -->
                <div id="analysis-response-area" class="mt-4 bg-gray-50 border border-gray-200 rounded-lg p-4 max-h-60 overflow-y-auto">
                    <p id="analysis-response-text" class="text-gray-700 italic">Insights will appear here...</p>
                    <div id="analysis-loading" class="hidden text-center text-blue-500">
                        <div class="animate-spin inline-block w-5 h-5 border-2 border-current border-t-transparent rounded-full mr-2"></div>
                        Generating AI insight...
                    </div>
                    <div id="analysis-citations" class="mt-3 text-xs text-gray-500 hidden">
                        <p class="font-semibold mb-1">Sources:</p>
                        <ul id="citation-list" class="list-disc list-inside space-y-1"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 4. SHOPPING CART MODAL -->
    <div id="cart-modal" onclick="if(event.target.id === 'cart-modal') window.closeCartModal()" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-xl flex flex-col h-full max-h-[90vh]">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-5 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    <i data-lucide="shopping-cart" class="w-6 h-6 mr-2 text-briwill-primary"></i> Your Shopping Cart
                </h3>
                <button onclick="window.closeCartModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <!-- Cart Items Container -->
            <div id="cart-items-container" class="p-5 space-y-4 overflow-y-auto flex-grow">
                <!-- Cart items will be rendered here by JavaScript -->
            </div>

            <!-- Cart Summary and Checkout -->
            <div class="p-5 border-t border-gray-200 bg-gray-50">
                <div class="flex justify-between items-center text-lg font-semibold mb-3">
                    <span>Subtotal:</span>
                    <span id="cart-subtotal" class="text-2xl text-briwill-primary">$0.00</span>
                </div>
                <button class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center justify-center shadow-lg disabled:opacity-50" disabled>
                    Proceed to Checkout
                </button>
            </div>
        </div>
    </div>
    
    <!-- 5. INFO/SELLER PORTAL MODAL (NEW) -->
    <div id="info-modal" onclick="if(event.target.id === 'info-modal') window.closeInfoModal()" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-5 border-b border-gray-200">
                <h3 id="info-modal-title" class="text-xl font-bold text-gray-800 flex items-center">
                    Information
                </h3>
                <button onclick="window.closeInfoModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <!-- Modal Content -->
            <div id="info-modal-content" class="p-5 overflow-y-auto space-y-4">
                <!-- Content injected by JS -->
            </div>
        </div>
    </div>


    <!-- JavaScript for interactivity and product loading (LLM API + FIREBASE INTEGRATION) -->
    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, 
            signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, 
            setPersistence, browserSessionPersistence,
            GoogleAuthProvider, FacebookAuthProvider, signInWithPopup
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL STATE & CONFIG ---
        const API_KEY = ""; // Placeholder for Gemini API key
        let currentProduct = null;
        let allProducts = []; // Stores all products (source of truth)
        let currentCategory = 'All'; // Tracks the currently active filter
        window.userId = null;
        window.cartItems = []; // Array to hold cart items from Firestore
        let cartListenerUnsubscribe = null; // To hold the unsubscribe function for the real-time listener
        let isSigningOut = false; // Prevents re-login after a deliberate sign-out
        
        // MANDATORY CONFIG
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // Initialize Firebase services and providers
        let app, auth, db;
        const googleProvider = new GoogleAuthProvider();
        const facebookProvider = new FacebookAuthProvider();
        
        // --- UI UTILITIES ---

        function showAuthMessage(type, message) {
            const box = document.getElementById('auth-message-box');
            box.textContent = message;
            box.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800', 'bg-blue-100', 'text-blue-800');
            
            if (type === 'error') {
                box.classList.add('bg-red-100', 'text-red-800');
            } else if (type === 'success') {
                box.classList.add('bg-green-100', 'text-green-800');
            } else { // 'info' or default
                 box.classList.add('bg-blue-100', 'text-blue-800');
            }
        }

        function clearAuthMessage() {
            document.getElementById('auth-message-box').classList.add('hidden');
        }

        function showAppMessage(type, message, duration = 3000) {
            const box = document.getElementById('app-message-box');
            box.textContent = message;
            box.classList.remove('opacity-0', 'pointer-events-none', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800', 'bg-blue-100', 'text-blue-800');
            
            if (type === 'error') {
                box.classList.add('bg-red-100', 'text-red-800');
            } else if (type === 'success') {
                box.classList.add('bg-green-100', 'text-green-800');
            } else { // 'info' or default
                 box.classList.add('bg-blue-100', 'text-blue-800');
            }
            
            box.classList.add('opacity-100', 'pointer-events-auto');

            setTimeout(() => {
                box.classList.remove('opacity-100', 'pointer-events-auto');
                box.classList.add('opacity-0', 'pointer-events-none');
            }, duration);
        }
        
        // Function to control the full-screen authentication page visibility
        window.showAuthPage = (view = 'signin') => {
            const authPage = document.getElementById('auth-page');
            authPage.classList.remove('pointer-events-none', 'opacity-0');
            authPage.classList.add('pointer-events-auto', 'opacity-100');
            document.getElementById('main-app-content').style.display = 'none';
            clearAuthMessage();
            window.showAuthView(view);
            lucide.createIcons();
        }

        window.hideAuthPage = () => {
             const authPage = document.getElementById('auth-page');
            authPage.classList.remove('pointer-events-auto', 'opacity-100');
            authPage.classList.add('pointer-events-none', 'opacity-0');
            setTimeout(() => {
                 document.getElementById('main-app-content').style.display = 'block';
            }, 300); // Wait for transition
        }

        window.showAuthView = (view) => {
            const signinView = document.getElementById('signin-view');
            const signupView = document.getElementById('signup-view');
            const signinTab = document.getElementById('signin-tab');
            const signupTab = document.getElementById('signup-tab');
            clearAuthMessage();

            if (view === 'signin') {
                signinView.classList.remove('hidden');
                signupView.classList.add('hidden');
                signinTab.classList.add('border-briwill-primary', 'text-gray-900');
                signupTab.classList.remove('border-briwill-primary', 'text-gray-900');
                signupTab.classList.add('border-gray-200', 'text-gray-400');
            } else if (view === 'signup') {
                signupView.classList.remove('hidden');
                signinView.classList.add('hidden');
                signupTab.classList.add('border-briwill-primary', 'text-gray-900');
                signinTab.classList.remove('border-briwill-primary', 'text-gray-900');
                signinTab.classList.add('border-gray-200', 'text-gray-400');
            }
        }
        
        // --- INFO MODAL LOGIC (NEW) ---
        window.closeInfoModal = () => {
            document.getElementById('info-modal').classList.add('hidden');
            document.getElementById('info-modal').classList.remove('flex');
        }

        window.showSellerPortal = (event) => {
            if (event) event.preventDefault();
            const modal = document.getElementById('info-modal');
            const title = document.getElementById('info-modal-title');
            const content = document.getElementById('info-modal-content');

            title.innerHTML = `<i data-lucide="store" class="w-6 h-6 mr-2 text-briwill-primary"></i> Start Selling on Briwill`;
            content.innerHTML = `
                <h3 class="text-xl font-bold text-gray-800 mb-3">Become a Briwill Seller</h3>
                <p class="mb-4 text-gray-600">Join our marketplace and reach millions of customers. We provide the tools for easy listing, inventory management, and secure payments.</p>
                
                <div class="space-y-4">
                    <div class="p-4 bg-green-50 rounded-lg border border-green-200 shadow-sm">
                        <h4 class="font-semibold text-green-700 flex items-center mb-1"><i data-lucide="check-circle" class="w-5 h-5 mr-2"></i> Simple Setup</h4>
                        <p class="text-sm text-green-600">Create your seller profile in minutes with no upfront fees.</p>
                    </div>
                    <div class="p-4 bg-blue-50 rounded-lg border border-blue-200 shadow-sm">
                        <h4 class="font-semibold text-blue-700 flex items-center mb-1"><i data-lucide="bar-chart-3" class="w-5 h-5 mr-2"></i> Powerful Analytics</h4>
                        <p class="text-sm text-blue-600">Track your sales and customer trends with our free analytics dashboard.</p>
                    </div>
                </div>
                
                <form class="mt-6 p-4 bg-gray-100 rounded-xl shadow-inner">
                    <h4 class="font-bold text-gray-700 mb-3 text-lg">Register Your Interest</h4>
                    <input id="seller-email" type="email" placeholder="Your Email Address" class="w-full border-2 border-gray-300 rounded-lg p-3 focus:ring-briwill-primary focus:border-briwill-primary mb-3">
                    <button type="button" onclick="window.submitSellerRegistration(event)" class="w-full bg-briwill-primary text-white font-bold py-3 rounded-lg hover:bg-amber-600 transition shadow-md">
                        Register Now
                    </button>
                </form>
                `;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            lucide.createIcons();
        }

        window.submitSellerRegistration = (event) => {
            event.preventDefault();
            const email = document.getElementById('seller-email').value;
            if (!email) {
                 showAppMessage('error', 'Please enter a valid email address.');
                 return;
            }
            // In a real app, this would submit data to a backend.
            window.closeInfoModal();
            showAppMessage('success', `Thank you for your interest, ${email}! We will reach out to you shortly to start your selling journey.`, 5000);
        }

        // --- FIREBASE AUTHENTICATION LOGIC ---

        function getCartDocRef(userId) {
            // Path: /artifacts/{appId}/users/{userId}/cart/user_cart
            return doc(db, 'artifacts', appId, 'users', userId, 'cart', 'user_cart');
        }

        function startCartListener(userId) {
            // Unsubscribe from any previous listener
            if (cartListenerUnsubscribe) {
                cartListenerUnsubscribe();
            }

            const cartRef = getCartDocRef(userId);
            
            cartListenerUnsubscribe = onSnapshot(cartRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    // Cart data is an object with an 'items' array
                    window.cartItems = docSnapshot.data().items || [];
                    console.log("Cart updated:", window.cartItems);
                } else {
                    // Document does not exist, initialize with an empty cart
                    window.cartItems = [];
                    // setDoc(cartRef, { items: [] }, { merge: true }).catch(e => console.error("Error initializing cart:", e));
                }
                updateCartBadge();
                // If the cart modal is visible, re-render the contents
                if (!document.getElementById('cart-modal').classList.contains('hidden')) {
                    renderCart();
                }

            }, (error) => {
                console.error("Cart real-time listener error:", error);
            });
        }
        
        function stopCartListener() {
            if (cartListenerUnsubscribe) {
                cartListenerUnsubscribe();
                cartListenerUnsubscribe = null;
                window.cartItems = [];
                updateCartBadge();
            }
        }

        function updateCartBadge() {
            const cartCountElement = document.getElementById('cart-count');
            const totalItems = window.cartItems.reduce((sum, item) => sum + item.quantity, 0);
            cartCountElement.textContent = totalItems;
        }


        function updateUIOnLogin(user) {
            const userStatusCard = document.getElementById('user-status-card');
            const accountButton = document.getElementById('account-button');

            if (user && user.uid) {
                window.userId = user.uid;
                userStatusCard.classList.remove('hidden');
                document.getElementById('user-id-display').textContent = user.uid;
                document.getElementById('user-email-display').textContent = user.email || (user.isAnonymous ? 'Guest User (Anonymous)' : 'Unknown User');
                
                // Start listening to cart changes for the new user
                startCartListener(user.uid);

                // If logged in, hide the full-screen auth page
                window.hideAuthPage();

                // Update account button appearance and functionality
                accountButton.onclick = () => showAppMessage('info', 'You are already logged in. Your ID is visible below.');
                accountButton.classList.add('text-green-600', 'hover:text-green-800');
                accountButton.classList.remove('text-gray-700', 'hover:text-briwill-primary');
                
            } else {
                window.userId = null;
                stopCartListener(); // Stop listening if user logs out
                userStatusCard.classList.add('hidden');
                
                // Reset account button to open auth page
                accountButton.onclick = () => window.showAuthPage('signin');
                accountButton.classList.remove('text-green-600', 'hover:text-green-800');
                accountButton.classList.add('text-gray-700', 'hover:text-briwill-primary');
            }
        }

        async function initFirebaseAuth() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                     console.error("Firebase config is empty. Cannot initialize Firebase services.");
                     return;
                }
                
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('debug'); // Enable Firestore logging

                // Set session persistence
                await setPersistence(auth, browserSessionPersistence);

                // Main authentication listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        updateUIOnLogin(user);
                    } else {
                        // FIX: Only attempt auto-sign in if it's NOT a manual sign-out event.
                        if (!isSigningOut) {
                            try {
                                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                    // Attempt to sign in with the custom token
                                    await signInWithCustomToken(auth, __initial_auth_token);
                                } else {
                                    // Fallback to anonymous sign-in if token is missing (required by instructions)
                                    await signInAnonymously(auth);
                                }
                            } catch (error) {
                                console.error("Firebase Initial Auth/Fallback Error:", error);
                                updateUIOnLogin(null); // Ensure UI reflects logged-out state on failure
                            }
                        } else {
                            // If isSigningOut is true, it means the user explicitly clicked sign out.
                            // We update the UI to reflect logged-out state and reset the flag.
                            updateUIOnLogin(null);
                            isSigningOut = false; // Reset the flag
                        }
                    }
                });

            } catch (error) {
                console.error("Fatal Firebase Initialization Error:", error);
                showAuthMessage('error', `Initialization failed: ${error.message}`);
            }
        }

        // --- Email/Password Handlers ---

        window.handleSignIn = async () => {
            clearAuthMessage();
            const email = document.getElementById('signin-email').value;
            const password = document.getElementById('signin-password').value;
            const btn = document.getElementById('signin-btn-text');
            
            if (!email || !password) {
                showAuthMessage('error', 'Please enter both email and password.');
                return;
            }

            btn.textContent = 'Signing In...';
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showAuthMessage('success', 'Sign In successful! Redirecting...');
            } catch (error) {
                console.error("Sign In Error:", error);
                const message = error.code.includes('auth/invalid') ? 'Invalid email or password.' : error.message;
                showAuthMessage('error', `Sign In Failed: ${message}`);
            } finally {
                btn.textContent = 'Sign In with Email';
            }
        };

        window.handleSignUp = async () => {
            clearAuthMessage();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const btn = document.getElementById('signup-btn-text');

            if (!email || password.length < 6) {
                showAuthMessage('error', 'Please use a valid email and a password of 6 characters or more.');
                return;
            }

            btn.textContent = 'Creating...';
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showAuthMessage('success', 'Account created! Redirecting...');
            } catch (error) {
                console.error("Sign Up Error:", error);
                const message = error.code.includes('auth/email-already-in-use') ? 'This email is already in use.' : error.message;
                showAuthMessage('error', `Sign Up Failed: ${message}`);
            } finally {
                btn.textContent = 'Create Account';
            }
        };

        // --- Social Sign-In Handlers (UPDATED) ---
        
        async function handleSocialSignIn(provider, providerName) {
            clearAuthMessage();
            // Show an informative message that a popup is expected
            showAuthMessage('info', `Attempting to sign in with ${providerName}... (A new window should open and close automatically if successful)`);
            try {
                // Use a popup to sign in
                const result = await signInWithPopup(auth, provider);
                // Auth page will hide via onAuthStateChanged listener
                console.log(`Successfully signed in with ${providerName}:`, result.user);
            } catch (error) {
                console.error(`${providerName} Sign In Error:`, error);
                let message = `Failed to sign in with ${providerName}.`;
                
                if (error.code === 'auth/popup-closed-by-user') {
                    message = `${providerName} authentication window was closed. Please ensure pop-ups are allowed and try again.`;
                } else if (error.code === 'auth/unauthorized-domain') {
                    // Specific error for this environment
                     message = `Failed: This environment's domain is not authorized for social login in Firebase. Please use **Email/Password** or rely on the automatic **Guest Login** instead.`;
                } else if (error.code === 'auth/cancelled-popup-request') {
                     message = `Authentication was interrupted. Please try again or use Email/Password.`;
                } else {
                    message = `Sign In Failed: ${error.message}. Please use **Email/Password** for reliable login in this environment.`;
                }
                
                showAuthMessage('error', message);
            }
        }

        window.handleGoogleSignIn = () => handleSocialSignIn(googleProvider, 'Google');
        window.handleFacebookSignIn = () => handleSocialSignIn(facebookProvider, 'Facebook');

        // --- Sign Out ---
        window.handleSignOut = async () => {
            try {
                isSigningOut = true; // Set flag BEFORE calling signOut
                await signOut(auth);
                // UI update handled by onAuthStateChanged
                showAppMessage('info', 'You have been signed out.');
            } catch (error) {
                console.error("Sign Out Error:", error);
                isSigningOut = false; // Reset if signOut failed
                showAppMessage('error', 'Sign out failed. Check console for details.');
            }
        };

        // --- QUICK ACCESS LINK HANDLERS ---

        window.handleFlashDeals = () => {
            const featuredSection = document.getElementById('product-grid');
            const flashDealsElement = document.getElementById('flash-deals');
            
            if (featuredSection) {
                // Scroll smoothly to the featured products section
                featuredSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                showAppMessage('success', 'Flashing to today\'s best deals!');
            }
            
            // Add visual feedback flash
            if (flashDealsElement) {
                 flashDealsElement.classList.add('bg-yellow-200');
                 setTimeout(() => {
                    flashDealsElement.classList.remove('bg-yellow-200');
                 }, 500);
            }
        };

        window.handleQuickLink = (featureName) => {
            // Placeholder functionality: Show a quick message to the user
            const elementId = featureName.toLowerCase().replace(/\s/g, '-');
            const element = document.getElementById(elementId);

            if (element) {
                 // Add visual feedback flash
                 element.classList.add('bg-blue-200');
                 setTimeout(() => {
                    element.classList.remove('bg-blue-200');
                 }, 500);
            }
            
            showAppMessage('info', `Feature: ${featureName} is coming soon! This is where you'd navigate to that category.`);
        };


        // --- E-COMMERCE CORE LOGIC ---

        function getProductById(productId) {
            // IDs are stored as numbers in the mock data, ensure comparison is correct
            return allProducts.find(p => p.id === productId);
        }

        function initApp() {
            lucide.createIcons();
            initFirebaseAuth();
            document.getElementById('current-year').textContent = new Date().getFullYear();

            // Setup the main event listener for cart interactions using delegation
            setupCartEventListeners();

            // --- PRODUCT DATA WITH CATEGORIES AND MOCK IMAGES ---
            allProducts = [
                // --- ELECTRONICS (Tech) ---
                { id: 1, name: "Ultra-Thin 14-inch Laptop", price: 1199.99, oldPrice: 1499.99, discount: 20, image: "https://placehold.co/400x400/3498db/FFFFFF?text=Modern+Laptop", rating: 4.7, category: "Tech" },
                { id: 2, name: "Ergonomic 4K Monitor", price: 349.99, oldPrice: 429.99, discount: 18, image: "https://placehold.co/400x400/2ecc71/FFFFFF?text=4K+Monitor", rating: 4.5, category: "Tech" },
                { id: 3, name: "Pro Gaming Mouse", price: 59.99, oldPrice: null, discount: 0, image: "https://placehold.co/400x400/e74c3c/FFFFFF?text=Gaming+Mouse", rating: 4.8, category: "Tech" },
                
                // --- FASHION (Apparel) ---
                { id: 4, name: "Premium Leather Jacket", price: 299.00, oldPrice: 450.00, discount: 33, image: "https://placehold.co/400x400/f39c12/FFFFFF?text=Leather+Jacket", rating: 4.3, category: "Apparel" },
                { id: 5, name: "Mesh Running Shoes (Unisex)", price: 79.50, oldPrice: 99.00, discount: 20, image: "https://placehold.co/400x400/9b59b6/FFFFFF?text=Running+Shoes", rating: 4.6, category: "Apparel" },
                { id: 6, name: "Classic Denim Jeans", price: 49.99, oldPrice: null, discount: 0, image: "https://placehold.co/400x400/1abc9c/FFFFFF?text=Denim+Jeans", rating: 4.1, category: "Apparel" },

                // --- HOME & KITCHEN (Home) ---
                { id: 7, name: "Digital Air Fryer 5L", price: 89.99, oldPrice: 139.99, discount: 36, image: "https://placehold.co/400x400/e67e22/FFFFFF?text=Air+Fryer", rating: 4.7, category: "Home" },
                { id: 8, name: "Smart Voice Assistant Speaker", price: 59.99, oldPrice: 89.99, discount: 33, image: "https://placehold.co/400x400/7f8c8d/FFFFFF?text=Smart+Speaker", rating: 4.5, category: "Home" },
                { id: 9, name: "Ergonomic Office Chair", price: 199.00, oldPrice: 250.00, discount: 20, image: "https://placehold.co/400x400/34495e/FFFFFF?text=Office+Chair", rating: 4.4, category: "Home" },
            ];
            
            // Initial render: show all products
            window.filterProducts('All');
        }

        /**
         * Filters the products based on category and updates the UI.
         * @param {string} categoryName - The category to filter by, or 'All'.
         */
        window.filterProducts = (categoryName) => {
            currentCategory = categoryName;
            
            const filteredProducts = currentCategory === 'All' 
                ? allProducts 
                : allProducts.filter(p => p.category === currentCategory);
            
            // Update the grid title
            const title = currentCategory === 'All' ? 'All Featured Products' : `${currentCategory} Products`;
            document.getElementById('product-grid-title').textContent = title;
            
            // Update the UI to show the active link
            setActiveCategory(categoryName);
            
            // Render the filtered list
            renderProducts(filteredProducts);
            
            // Close mobile menu if filter is selected on mobile
             document.getElementById('mobile-menu').classList.add('hidden');
        }

        /**
         * Manages the active visual state of the category links in the sidebar and mobile menu.
         * @param {string} activeCategory - The category that is currently active.
         */
        function setActiveCategory(activeCategory) {
            // Reset all desktop links
            ['All', 'Tech', 'Apparel', 'Home'].forEach(cat => {
                const desktopLink = document.getElementById(`desktop-filter-${cat}`);
                if (desktopLink) {
                    desktopLink.classList.remove('font-bold', 'text-briwill-primary', 'bg-yellow-50');
                    desktopLink.classList.add('text-gray-600');
                }
                const mobileLink = document.getElementById(`mobile-filter-${cat}`);
                 if (mobileLink) {
                    mobileLink.classList.remove('font-bold', 'text-briwill-primary', 'bg-gray-100');
                    mobileLink.classList.add('text-gray-700');
                }
            });

            // Set active desktop link
            const desktopActiveLink = document.getElementById(`desktop-filter-${activeCategory}`);
            if (desktopActiveLink) {
                desktopActiveLink.classList.add('font-bold', 'text-briwill-primary', 'bg-yellow-50');
                desktopActiveLink.classList.remove('text-gray-600');
            }
            
            // Set active mobile link
            const mobileActiveLink = document.getElementById(`mobile-filter-${activeCategory}`);
            if (mobileActiveLink) {
                mobileActiveLink.classList.add('font-bold', 'text-briwill-primary', 'bg-gray-100');
                mobileActiveLink.classList.remove('text-gray-700');
            }
            
            // Ensure icons are re-created for potential color changes
            lucide.createIcons(); 
        }


        function generateStars(rating) {
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.5;
            let starsHtml = '';
            for (let i = 0; i < 5; i++) {
                if (i < fullStars) {
                    starsHtml += `<i data-lucide="star" class="w-4 h-4 text-yellow-500 fill-yellow-500"></i>`;
                } else if (i === fullStars && halfStar) {
                    starsHtml += `<i data-lucide="star-half" class="w-4 h-4 text-yellow-500 fill-yellow-500"></i>`;
                } else {
                    starsHtml += `<i data-lucide="star" class="w-4 h-4 text-gray-300"></i>`;
                }
            }
            return starsHtml;
        }

        /**
         * Renders the product cards based on the provided list of products.
         * @param {Array<Object>} productsToDisplay - The filtered list of products.
         */
        function renderProducts(productsToDisplay) {
            const productGrid = document.getElementById('product-grid');
            productGrid.innerHTML = ''; 
            
            if (productsToDisplay.length === 0) {
                 productGrid.innerHTML = `
                    <div class="col-span-full text-center p-12 bg-white rounded-xl shadow-md">
                        <i data-lucide="box-select" class="w-12 h-12 mx-auto text-gray-400 mb-4"></i>
                        <p class="text-xl font-semibold text-gray-700">No products found in the "${currentCategory}" category.</p>
                        <p class="text-sm text-gray-500 mt-2">Try selecting "All Products" to see everything.</p>
                    </div>
                 `;
                 lucide.createIcons();
                 return;
            }

            productsToDisplay.forEach(product => {
                const discountBadge = product.discount > 0 ? 
                    `<span class="absolute top-2 right-2 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-full shadow-lg">-${product.discount}%</span>` : 
                    '';

                const oldPriceHtml = product.oldPrice ? 
                    `<span class="text-xs text-gray-500 line-through mr-2">$${product.oldPrice.toFixed(2)}</span>` : 
                    '';

                const productCard = `
                    <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition duration-300 transform hover:-translate-y-1 overflow-hidden cursor-pointer relative">
                        ${discountBadge}
                        <div class="relative pt-[100%]">
                            <img src="${product.image}" onerror="this.onerror=null; this.src='https://placehold.co/400x400/eeeeee/333333?text=Image+Error';" alt="${product.name}" 
                                class="absolute top-0 left-0 w-full h-full object-cover p-4">
                        </div>
                        <div class="p-3">
                            <!-- Displaying the actual category from the product data -->
                            <p class="text-xs text-gray-500 mb-1 truncate">${product.category}</p> 
                            <h3 class="text-sm font-semibold text-gray-900 mb-2 h-10 overflow-hidden" title="${product.name}">${product.name}</h3>
                            
                            <!-- Rating -->
                            <div class="flex items-center mb-2">
                                ${generateStars(product.rating)}
                                <span class="text-xs text-gray-600 ml-2">(${product.rating})</span>
                            </div>

                            <!-- Price -->
                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <p class="text-lg font-bold text-briwill-primary">$${product.price.toFixed(2)}</p>
                                    ${oldPriceHtml}
                                </div>
                                <button onclick="window.handleAddToCart(event, ${product.id})" class="bg-blue-600 text-white p-2 rounded-full hover:bg-blue-700 transition duration-150 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                </button>
                            </div>
                            
                            <!-- AI Feature -->
                            <div class="flex">
                                <button onclick="window.openAnalysisModal(event, ${product.id})" class="w-full text-xs py-2 px-1 rounded-lg bg-yellow-50 text-gray-700 hover:bg-yellow-100 transition duration-150 border border-yellow-200 font-semibold">
                                    âœ¨ AI Product Analysis
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                productGrid.innerHTML += productCard;
            });
            
            lucide.createIcons();
        }

        // --- CART FIREBASE LOGIC ---

        async function addToCartInFirestore(productId) {
            if (!window.userId) {
                // Not logged in, show auth page
                window.showAuthPage('signin');
                return;
            }

            const product = getProductById(productId);
            if (!product) return;

            const cartRef = getCartDocRef(window.userId);
            
            // Check if the item already exists in the cart
            const existingItemIndex = window.cartItems.findIndex(item => item.id === productId);
            
            let newCartItems;

            if (existingItemIndex > -1) {
                // Item exists: increase quantity
                newCartItems = window.cartItems.map((item, index) => {
                    if (index === existingItemIndex) {
                        return { ...item, quantity: item.quantity + 1 };
                    }
                    return item;
                });
            } else {
                // Item is new: add to cart
                const newItem = {
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    image: product.image,
                    quantity: 1
                };
                newCartItems = [...window.cartItems, newItem];
            }

            try {
                // Write the updated array back to Firestore
                await setDoc(cartRef, { items: newCartItems });
            } catch (error) {
                console.error("Error updating cart in Firestore:", error);
                // Optionally show a modal error here
            }
        }

        async function removeFromCartInFirestore(productId) {
            if (!window.userId) return;

            const cartRef = getCartDocRef(window.userId);
            
            // Filter out the item to be removed
            const newCartItems = window.cartItems.filter(item => item.id !== productId);

            try {
                await setDoc(cartRef, { items: newCartItems });
                console.log(`Item ${productId} removed from cart successfully.`);
            } catch (error) {
                console.error("Error removing item from cart in Firestore:", error);
            }
        }

        async function updateCartQuantity(productId, change) {
            if (!window.userId) return;

            const cartRef = getCartDocRef(window.userId);
            const existingItemIndex = window.cartItems.findIndex(item => item.id === productId);

            if (existingItemIndex === -1) return;

            let newCartItems = [...window.cartItems];
            const currentQuantity = newCartItems[existingItemIndex].quantity;
            const newQuantity = currentQuantity + change;

            if (newQuantity <= 0) {
                // Remove item if quantity is zero or less
                newCartItems = newCartItems.filter(item => item.id !== productId);
            } else {
                // Update quantity
                newCartItems[existingItemIndex].quantity = newQuantity;
            }

            try {
                await setDoc(cartRef, { items: newCartItems });
                console.log(`Quantity for item ${productId} updated successfully to ${newQuantity > 0 ? newQuantity : 0}.`);
            } catch (error) {
                console.error("Error changing quantity in Firestore:", error);
            }
        }

        // --- CART UI LOGIC ---

        window.handleAddToCart = (event, productId) => {
            event.stopPropagation();
            event.preventDefault(); 
            
            addToCartInFirestore(productId);

            // Simple visual feedback on the button
            const button = event.currentTarget;
            button.classList.add('bg-green-500');
            button.classList.remove('bg-blue-600');
            setTimeout(() => {
                button.classList.remove('bg-green-500');
                button.classList.add('bg-blue-600');
            }, 500);
        };

        window.showCartModal = () => {
            document.getElementById('cart-modal').classList.remove('hidden');
            document.getElementById('cart-modal').classList.add('flex');
            // renderCart is now called automatically via the onSnapshot listener if the modal is open
            renderCart(); 
            lucide.createIcons();
        }

        window.closeCartModal = () => {
            document.getElementById('cart-modal').classList.add('hidden');
            document.getElementById('cart-modal').classList.remove('flex');
        }

        // --- EVENT DELEGATION SETUP (FIX) ---
        function setupCartEventListeners() {
            const cartItemsContainer = document.getElementById('cart-items-container');
            
            cartItemsContainer.addEventListener('click', (event) => {
                const target = event.target.closest('button[data-action]');
                
                if (!target) return;
                
                const action = target.getAttribute('data-action');
                const productId = parseInt(target.getAttribute('data-id'));

                if (isNaN(productId)) {
                    console.error("Invalid product ID on cart button.");
                    return;
                }

                switch (action) {
                    case 'remove-item':
                        removeFromCartInFirestore(productId);
                        break;
                    case 'update-quantity':
                        const change = parseInt(target.getAttribute('data-change'));
                        if (!isNaN(change)) {
                            updateCartQuantity(productId, change);
                        }
                        break;
                    default:
                        console.warn("Unhandled cart action:", action);
                }
            });
        }


        function renderCart() {
            const container = document.getElementById('cart-items-container');
            const subtotalElement = document.getElementById('cart-subtotal');
            let subtotal = 0;
            let cartHtml = '';
            
            if (window.cartItems.length === 0) {
                cartHtml = `
                    <div class="text-center p-8 bg-gray-100 rounded-lg">
                        <i data-lucide="shopping-bag" class="w-12 h-12 mx-auto text-gray-400 mb-4"></i>
                        <p class="text-lg font-semibold text-gray-700">Your cart is empty.</p>
                        <p class="text-sm text-gray-500 mt-1">Start adding products to see them here!</p>
                    </div>
                `;
            } else {
                window.cartItems.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    subtotal += itemTotal;
                    
                    cartHtml += `
                        <div class="flex items-center border-b border-gray-200 py-3">
                            <img src="${item.image}" onerror="this.onerror=null; this.src='https://placehold.co/100x100/eeeeee/333333?text=N/A';" class="w-16 h-16 object-cover rounded-lg mr-4" alt="${item.name}">
                            <div class="flex-grow">
                                <h4 class="font-semibold text-gray-800 text-sm">${item.name}</h4>
                                <p class="text-xs text-gray-500">$${item.price.toFixed(2)} each</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <!-- Quantity Decrease Button (uses event delegation) -->
                                <button data-action="update-quantity" data-id="${item.id}" data-change="-1" class="p-1 border border-gray-300 rounded-full hover:bg-gray-100 transition">
                                    <i data-lucide="minus" class="w-4 h-4 pointer-events-none"></i>
                                </button>
                                <span class="font-bold text-sm w-5 text-center">${item.quantity}</span>
                                <!-- Quantity Increase Button (uses event delegation) -->
                                <button data-action="update-quantity" data-id="${item.id}" data-change="1" class="p-1 border border-gray-300 rounded-full hover:bg-gray-100 transition">
                                    <i data-lucide="plus" class="w-4 h-4 pointer-events-none"></i>
                                </button>
                            </div>
                            <div class="w-20 text-right">
                                <p class="font-bold text-gray-900">$${itemTotal.toFixed(2)}</p>
                            </div>
                            <!-- Remove Item Button (uses event delegation) -->
                            <button data-action="remove-item" data-id="${item.id}" class="ml-4 text-red-500 hover:text-red-700 transition">
                                <i data-lucide="trash-2" class="w-5 h-5 pointer-events-none"></i>
                            </button>
                        </div>
                    `;
                });
            }

            container.innerHTML = cartHtml;
            subtotalElement.textContent = `$${subtotal.toFixed(2)}`;
            lucide.createIcons(); // Re-render icons after adding new HTML
        }


        // --- LLM MODAL AND ANALYSIS LOGIC (EXISTING) ---

        window.openAnalysisModal = (event, productId) => {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            currentProduct = getProductById(productId);
            document.getElementById('analysis-product-name').textContent = `Analyzing: ${currentProduct.name}`;
            document.getElementById('analysis-response-text').textContent = 'Insights will appear here...';
            document.getElementById('analysis-response-text').classList.add('italic');
            document.getElementById('analysis-citations').classList.add('hidden');
            document.getElementById('citation-list').innerHTML = '';
            document.getElementById('analysis-query').value = '';
            document.getElementById('analysis-modal').classList.remove('hidden');
            document.getElementById('analysis-modal').classList.add('flex');
            lucide.createIcons();
        }

        window.closeAnalysisModal = () => {
            document.getElementById('analysis-modal').classList.add('hidden');
            document.getElementById('analysis-modal').classList.remove('flex');
            currentProduct = null;
        }

        window.submitAnalysisQuery = async () => {
            const query = document.getElementById('analysis-query').value.trim();
            if (!query || !currentProduct) return;

            const productName = currentProduct.name;
            const price = currentProduct.price.toFixed(2);
            const systemPrompt = `You are a world-class e-commerce product analyst. Your task is to analyze the user's query about the product: "${productName}" (priced at $${price}) and provide a helpful, objective, and concise answer suitable for an online shopper. Use web search grounding to provide accurate and up-to-date context, especially for comparisons or technical details. Do not use markdown headers or lists in your final answer.`;
            const userQuery = `Product: ${productName}. Price: $${price}. User Question: ${query}`;
            
            const submitBtn = document.getElementById('analysis-submit-btn');
            const loadingDiv = document.getElementById('analysis-loading');
            const responseText = document.getElementById('analysis-response-text');
            const citationList = document.getElementById('citation-list');
            const citationsDiv = document.getElementById('analysis-citations');

            submitBtn.disabled = true;
            document.getElementById('analysis-btn-text').textContent = 'Generating...';
            loadingDiv.classList.remove('hidden');
            responseText.textContent = '';
            responseText.classList.remove('italic');
            citationsDiv.classList.add('hidden');
            citationList.innerHTML = '';

            try {
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    tools: [{ "google_search": {} }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                const result = await callGeminiApi('gemini-2.5-flash-preview-09-2025', payload);
                const candidate = result.candidates?.[0];
                let text = 'Sorry, I could not generate an insight right now.';

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    text = candidate.content.parts[0].text;
                    
                    // Extract and display citations if available
                    const groundingMetadata = candidate.groundingMetadata;
                    let sources = [];
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }
                    
                    if (sources.length > 0) {
                        citationsDiv.classList.remove('hidden');
                        sources.forEach(source => {
                            const li = document.createElement('li');
                            li.innerHTML = `<a href="${source.uri}" target="_blank" class="text-blue-500 hover:underline" title="${source.title}">${source.title || new URL(source.uri).hostname}</a>`;
                            citationList.appendChild(li);
                        });
                    }
                }
                
                responseText.textContent = text;


            } catch (error) {
                responseText.textContent = 'Error: Failed to fetch AI analysis. Please try again later.';
                console.error('Analysis submission error:', error);
            } finally {
                submitBtn.disabled = false;
                document.getElementById('analysis-btn-text').textContent = 'Get Insight';
                loadingDiv.classList.add('hidden');
            }
        }

        // Generic Gemini API Caller with exponential backoff
        async function callGeminiApi(model, payload, retries = 3) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${API_KEY}`;

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429 && i < retries - 1) {
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }

                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`API call failed with status ${response.status}: ${errorBody}`);
                    }

                    return await response.json();

                } catch (error) {
                    if (i === retries - 1) throw error;
                }
            }
        }


        // Mobile Menu Toggle
        document.getElementById('menu-toggle').addEventListener('click', () => {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        });

        // Run initialization when DOM is ready
        document.addEventListener('DOMContentLoaded', initApp);
        
    </script>
</body>
</html>